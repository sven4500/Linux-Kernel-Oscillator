# Синтезатор звуковых волн Linux

Данный проект содержит исходный код синтезатора звуковых волн, реализованный на уровне модуля ядра Linux. Код актуален для версии ядра 6.1.130 и поставляется "как есть". В коде присутствуют некоторые известные не решённые ошибки и проблемы (см. описание ниже).

## Общее описание

Модуль ядра представляет собой символьный драйвер для ОС Linux. Программа из пользовательского пространства отправляет через ioctl драйверу команду "сгенерировать звуковую волну" (`CMDADDWAVE`). Команда содержит такие характеристики звуковой волны как частота, амплитуда и фаза (на данный момент реализована только частота).

Драйвер использует подсистему для работы со звуком ALSA (продвинутая архитектура звука Linux). Драйвер генерирует звуковую волну и пишет её в буфер звукового устройства. Пока не был найден удовлетворительный способ писать звук прямиком в физический динамик устройства поэтому драйвер представляет собой виртуальный микрофон, поток которого через утилиту `alsaloop` может быть перенаправлен в физический динамик (см. описание ниже).

Команда `CMDADDWAVE` может быть отправлена многократно, одной или несколькими программами из пользовательского пространства. Драйвер складывает отдельные волны в единый звуковой сигнал. Команда `CMDREMOVEWAVE` удаляет волну заданной частоты.

## Структура волны

Программа из пользовательского пространства вместе с командой ioctl отправляет одно 32-битное слово описывающее звуковую волну. В слово упаковываются три значения, характеризующие волну: частота, амплитуда и фаза. Используется следующее представление:

```
+--------------------+--------------------+----------------------+
| 0-6                | 7-15               | 16-31                |
+--------------------+--------------------+----------------------+
| амплитуда, 7 бит   | фаза, 9 бит        | частота, 16 бит      |
| 128 знач. (0..100) | 512 знач. (0..360) | 64к знач. (0..48000) |
+--------------------+--------------------+----------------------+
```

Для удобства упаковки/распаковки в коде представлен ряд макросов `MAKEWAVE`, `GETWAVEAMP`, `SETWAVEAMP` и пр.

## Как собрать

Makefile содержит несколько целей.

`kbuild` собирает модуль ядра и помещает собранный модуль в каталог build. Собранный модуль можно самостоятельно загрузить в ядро при помощи системной утилиты insmod.

`reinsmod` комплексная команда которая собирает модуль ядра, выгружает старый модуль (если ранее был загружен) и загружает новый. Удобно во время разработки или отладки.

`app_us` собирает программу пользовательского пространства для отправки команд драйверу.

Чтобы собрать модуль ядра и программу пользовательского пространства необходимо выполнить следующие команды:

```shell
$ sudo make kbuild
$ sudo make app_us
```

В каталоге build должны появится два файла ex_oscillator.ko (модуль ядра) и us_oscillator (программа пользовательского пространства).

## Как запустить

Чтобы загрузить модуль ядра в большинстве случаев достаточно выполнить следующую команду:

```shell
$ sudo make reinsmod
```

Если модуль ядра успешно загружен системная утилита dmesg должна показать сообщение: `kernel ALSA sound module loaded successfully`.

Когда модуль ядра загружен можно запустить программу пользовательского пространства (требуются привилегии суперпользователя), например, us_oscillator:

```shell
$ sudo ./build/us_oscillator
```

Через программу пользовательского пространства us_oscillator можно отправлять драйверу команды. Например, команда `a 100 0 480` отправляет драйверу запрос на генерацию звуковой волны 480 Гц  с амплитудой 100 и фазой 0. Команда `r 480` позволяет отменить ранее отправленный запрос на генерацию волны 480 Гц.

## Как настроить

Чтобы настроить вывод звуковой волны в физический динамик необходимо запустить утилиту alsaloop:

```shell
$ alsaloop -C hw:1,0 -P hw:0,0 -c 2 -f S16_LE -r 48000
```

Через аргументы `-C` (capture device) и `-P` (playback device) задаётся конфигурация перенаправление потоков. Значения зависят от конфигурации конкретной системы. Список доступных на конкретной машине устройств может быть получен через вызов утилиты `aplay -l` и `arecord -l`.

## Не решённые проблемы

1. Периодически появляется ошибка `buffer underrun`;
2. Нет плавающих точек поэтому сложно вычислить шаг и волны близкие по частоте не отличаются по звуку;
3. Не получается выгрузить модуль без флага -f (как будто удерживает ALSA);
4. Устройство capture в связке с физическим playback через alsaloop. Как писать в физический playback в обход alsaloop?

## Другие проблемы

1. Нет тригонометрических функци, используется __fixp_sin32;
2. Мало примеров использования alsa подсистемы в драйвере;
3. Подсветку пока что наилучшим образом удалось настроить в eclipse.
