# Синтезатор звуковых волн Linux

Данный проект содержит исходный код синтезатора звуковых волн, реализованный на уровне модуля ядра Linux. Код актуален для версии ядра 6.1.130 и поставляется "как есть". В коде присутствуют некоторые известные не решённые ошибки и проблемы (см. описание ниже).

## Общее описание

Модуль ядра представляет собой символьный драйвер для ОС Linux. Программа из пользовательского пространства отправляет через ioctl драйверу команду "сгенерировать звуковую волну" (`CMDADDWAVE`). Команда содержит такие характеристики звуковой волны как частота, амплитуда и фаза (на данный момент реализована только частота).

Драйвер использует подсистему для работы со звуком ALSA (продвинутая архитектура звука Linux). Драйвер генерирует звуковую волну и пишет её в буфер звукового устройства. Пока не был найден удовлетворительный способ писать звук прямиком в физический динамик устройства поэтому драйвер представляет собой виртуальный микрофон, поток которого через утилиту `alsaloop` может быть перенаправлен в физический динамик (см. описание ниже).

Команда `CMDADDWAVE` может быть отправлена многократно, одной или несколькими программами из пользовательского пространства. Драйвер складывает отдельные волны в единый звуковой сигнал. Команда `CMDREMOVEWAVE` удаляет волну заданной частоты.

## Структура волны

Программа из пользовательского пространства вместе с командой ioctl отправляет одно 32-битное слово описывающее звуковую волну. В слово упаковываются три значения, характеризующие волну: частота, амплитуда и фаза. Используется следующее представление:

```
+--------------------+--------------------+----------------------+
| 0-6                | 7-15               | 16-31                |
+--------------------+--------------------+----------------------+
| амплитуда, 7 бит   | фаза, 9 бит        | частота, 16 бит      |
| 128 знач. (0..100) | 512 знач. (0..360) | 64к знач. (0..48000) |
+--------------------+--------------------+----------------------+
```

## Проблемы с которыми столкнулся

1. Нет тригонометрических функци используется __fixp_sin32
2. Практически нет примеров использования alsa подсистемы в драйвере
3. Подсветку пока что наилучшим образом удалось настроить в eclipse

## Не решённые проблемы

1. Периодически появляется ошибка buffer underrun и поток на мгновение рвётся
2. Нет плавающих точек поэтому сложно вычислить шаг и волны близкие по частоте не отличаются по звуку
3. Не получается выгрузить модуль без флага -f, как будто удерживает ALSA
4. Устройство capture в связке с физическим playback через alsaloop. Как писать в физический playback в обход alsaloop?
